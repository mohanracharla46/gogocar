<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Continue to Payment - GoGo Self Drive Cars</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background: #f7fafc;
            color: #1a202c;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        /* Header */
        /* Consolidated media queries moved to bottom */
        .logo {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .logo-main {
            font-size: 32px;
            font-weight: 700;
            color: #ff6b35;
            letter-spacing: -1px;
        }

        .logo-sub {
            font-size: 12px;
            color: #4a5568;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .help-icon {
            width: 32px;
            height: 32px;
            background: #e2e8f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a202c;
            font-weight: 600;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .help-icon:hover {
            background: #cbd5e0;
        }

        /* Main Container */
        .main-container {
            max-width: 700px;
            margin: 120px auto 40px;
            background: #ffffff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Car Details */
        .car-details-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e2e8f0;
        }

        .car-image-container {
            flex-shrink: 0;
            width: 120px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            background: #f7fafc;
        }

        .car-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .car-info {
            flex: 1;
        }

        .car-model {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .car-specs {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 14px;
            color: #4a5568;
        }

        .car-spec {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .spec-icon {
            width: 16px;
            height: 16px;
            color: #64748b;
        }

        /* Protection Section */
        .protection-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e2e8f0;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .section-description {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .damage-protection-btn {
            position: relative;
        }

        .damage-protection-btn.selected {
            border-color: #3b82f6 !important;
            background: #eff6ff !important;
        }

        .damage-protection-btn.selected::before {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: #3b82f6;
            color: #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .deposit-option-card {
            position: relative;
        }

        .deposit-option-card input[type="radio"]:checked~div {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .deposit-option-card.selected {
            border-color: #3b82f6 !important;
            background: #eff6ff !important;
        }

        .deposit-option-card.selected::after {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: #3b82f6;
            color: #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        /* Pricing Summary */
        .pricing-summary-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e2e8f0;
        }

        .pricing-items {
            list-style: none;
            margin-bottom: 15px;
        }

        .pricing-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            font-size: 14px;
            color: #4a5568;
        }

        .pricing-item-name {
            flex: 1;
        }

        .pricing-item-amount {
            font-weight: 600;
            color: #1a202c;
        }

        .pricing-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-top: 2px solid #e2e8f0;
            margin-top: 15px;
        }

        .pricing-total-label {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
        }

        .pricing-total-amount {
            font-size: 24px;
            font-weight: 700;
            color: #1a202c;
        }

        /* Deposit */
        .deposit-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e2e8f0;
        }

        .deposit-card {
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 8px;
            padding: 20px;
        }

        .deposit-label {
            font-size: 16px;
            font-weight: 600;
            color: #166534;
            margin-bottom: 8px;
        }

        .deposit-amount {
            font-size: 20px;
            font-weight: 700;
            color: #166534;
            margin-bottom: 8px;
        }

        .deposit-note {
            font-size: 14px;
            color: #15803d;
        }

        /* KYC Upload Section */
        .kyc-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e2e8f0;
        }

        .kyc-warning {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .kyc-warning-text {
            font-size: 14px;
            color: #92400e;
            line-height: 1.5;
        }

        .kyc-documents {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .kyc-document-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
        }

        .kyc-document-label {
            font-size: 14px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 10px;
            display: block;
        }

        .kyc-upload-area {
            position: relative;
        }

        .kyc-upload-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .kyc-upload-button {
            background: #3b82f6;
            color: #ffffff;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background 0.3s ease;
        }

        .kyc-upload-button:hover {
            background: #2563eb;
        }

        .kyc-preview {
            margin-top: 10px;
        }

        .kyc-preview img {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .kyc-upload-status {
            font-size: 12px;
            color: #16a34a;
            margin-top: 5px;
            display: none;
        }

        .kyc-upload-status.uploaded {
            display: block;
        }

        /* Terms and Conditions Section */
        .terms-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e2e8f0;
        }

        .terms-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .terms-header:hover {
            background: #f1f5f9;
        }

        .terms-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
            margin: 0;
        }

        .terms-toggle {
            font-size: 20px;
            color: #64748b;
            transition: transform 0.3s ease;
        }

        .terms-toggle.expanded {
            transform: rotate(180deg);
        }

        .terms-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .terms-content.expanded {
            max-height: 2000px;
        }

        .terms-body {
            padding: 20px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
        }

        .terms-body h2 {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .terms-body h2:first-child {
            margin-top: 0;
        }

        .terms-body h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1a202c;
            margin-top: 15px;
            margin-bottom: 8px;
        }

        .terms-body p {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .terms-body ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .terms-body li {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .terms-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .terms-body table th,
        .terms-body table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e2e8f0;
        }

        .terms-body table th {
            background: #f1f5f9;
            font-weight: 600;
        }

        .terms-checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-top: 20px;
            padding: 15px;
            background: #fff5f2;
            border: 2px solid #ff6b35;
            border-radius: 8px;
        }

        .terms-checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .terms-checkbox-container label {
            font-size: 14px;
            color: #1a202c;
            cursor: pointer;
            line-height: 1.5;
        }

        .terms-checkbox-container label a {
            color: #ff6b35;
            text-decoration: underline;
        }

        /* Payment Button */
        .payment-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .payment-info {
            flex: 1;
        }

        .payment-label {
            font-size: 16px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 6px;
        }

        .payment-description {
            font-size: 12px;
            color: #4a5568;
            line-height: 1.4;
        }

        .pay-button {
            background: #ff6b35;
            color: #ffffff;
            padding: 16px 40px;
            border-radius: 8px;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            white-space: nowrap;
        }

        .pay-button:hover:not(:disabled) {
            background: #e55a2b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }

        .pay-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Responsive */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px 50px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Consolidated Media Queries for payment.html */
        @media (max-width: 1024px) {
            .main-container {
                margin: 110px auto 30px;
                padding: 25px;
            }
        }

        @media (max-width: 768px) {
            header {
                padding: 15px 20px;
            }

            .logo-main {
                font-size: 24px;
            }

            .main-container {
                margin: 100px auto 20px;
                padding: 20px;
            }

            .car-details-section {
                flex-direction: column;
                gap: 20px;
            }

            .car-image-container {
                width: 100%;
                height: 200px;
            }

            .kyc-documents {
                grid-template-columns: 1fr;
            }

            .payment-section {
                flex-direction: column;
                gap: 20px;
                align-items: stretch;
            }

            .pay-button {
                width: 100%;
                padding: 14px;
            }

            .terms-body {
                max-height: 400px;
            }

            .terms-body h2 {
                font-size: 18px;
            }

            .terms-body h3 {
                font-size: 15px;
            }

            .terms-body p,
            .terms-body li {
                font-size: 13px;
            }

            .damage-protection-btn {
                min-width: 100%;
            }
        }

        @media (max-width: 480px) {
            header {
                padding: 12px 15px;
            }

            .logo-main {
                font-size: 20px;
            }

            .logo-sub {
                font-size: 10px;
            }

            .page-title {
                font-size: 24px;
                margin-bottom: 20px;
            }

            .section-title {
                font-size: 18px;
            }

            .pricing-total-label {
                font-size: 18px;
            }

            .pricing-total-amount {
                font-size: 20px;
            }
        }
    </style>
    </style>
</head>

<body>
    <header>
        <div class="logo">
            <div class="logo-main">GoGo</div>
            <div class="logo-sub">SELF DRIVE CARS</div>
        </div>
        <div class="help-icon" title="Help">?</div>
    </header>

    <div class="main-container">
        <h1 class="page-title">Continue to Payment</h1>

        <!-- Booking Details -->
        <div class="booking-details-section"
            style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid #e2e8f0;">
            <h2 class="section-title">Booking Details</h2>
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
                <div>
                    <div style="font-size: 14px; color: #4a5568; margin-bottom: 5px;">Duration</div>
                    <div style="font-size: 18px; font-weight: 600; color: #1a202c;" id="bookingDuration">
                        {% if hours %}
                        {% set days = (hours / 24) | round(1) %}
                        {% if days >= 1 %}
                        {{ days | int }} day{% if days > 1 %}s{% endif %}
                        {% else %}
                        {{ hours }} hour{% if hours > 1 %}s{% endif %}
                        {% endif %}
                        {% else %}
                        1 day
                        {% endif %}
                    </div>
                </div>
                <div>
                    <div style="font-size: 14px; color: #4a5568; margin-bottom: 5px;">Pickup Location</div>
                    <div style="font-size: 18px; font-weight: 600; color: #1a202c;" id="pickupLocation">
                        {% if home_delivery and delivery_address %}
                        {{ delivery_address }}
                        {% elif car and car.location %}
                        {{ car.location.location }}
                        {% else %}
                        Location TBD
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Car Details -->
        <div class="car-details-section">
            <div class="car-image-container">
                <img src="{{ car_image if car_image else '/static/img/landing.png' }}" alt="Car" class="car-image"
                    id="carImage">
            </div>
            <div class="car-info">
                <h2 class="car-model" id="carModel">
                    {% if car %}{{ car.brand }} {{ car.car_model }}{% else %}Car{% endif %}
                </h2>
                <div class="car-specs">
                    {% if car %}
                    <div class="car-spec">
                        <svg class="spec-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" />
                        </svg>
                        <span>{% if car.no_of_seats.value == 'FIVE' %}5{% else %}7{% endif %} Seater</span>
                    </div>
                    <div class="car-spec">
                        <svg class="spec-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path
                                d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99z" />
                        </svg>
                        <span>{{ car.transmission_type.value.title() }}</span>
                    </div>
                    <div class="car-spec">
                        <svg class="spec-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="3" width="20" height="18" rx="2" />
                            <line x1="2" y1="8" x2="22" y2="8" />
                            <line x1="6" y1="3" x2="6" y2="8" />
                        </svg>
                        <span>{{ car.fuel_type.value.title() if car.fuel_type else 'N/A' }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Deposit Section -->
        <div class="deposit-section"
            style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid #e2e8f0;">
            <h2 class="section-title">Deposit</h2>
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <label class="deposit-option-card"
                    style="background: #ffffff; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s ease; position: relative; display: block;">
                    <input type="radio" name="deposit" value="bike_rc" style="display: none;" checked>
                    <div style="font-weight: 600; color: #1a202c; margin-bottom: 5px;">Bike & RC</div>
                    <div style="font-size: 12px; color: #4a5568;">Document deposit</div>
                </label>
                <label class="deposit-option-card"
                    style="background: #ffffff; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s ease; position: relative; display: block;">
                    <input type="radio" name="deposit" value="laptop" style="display: none;">
                    <div style="font-weight: 600; color: #1a202c; margin-bottom: 5px;">Laptop</div>
                    <div style="font-size: 12px; color: #4a5568;">Device deposit</div>
                </label>
                <label class="deposit-option-card"
                    style="background: #ffffff; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s ease; position: relative; display: block;">
                    <input type="radio" name="deposit" value="cheque" style="display: none;">
                    <div style="font-weight: 600; color: #1a202c; margin-bottom: 5px;">Empty Cheque</div>
                    <div style="font-size: 12px; color: #4a5568;">Blank cheque deposit</div>
                </label>
                <label class="deposit-option-card"
                    style="background: #ffffff; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s ease; position: relative; display: block;">
                    <input type="radio" name="deposit" value="cash" style="display: none;">
                    <div style="font-weight: 600; color: #1a202c; margin-bottom: 5px;">₹15,000 Cash</div>
                    <div style="font-size: 12px; color: #4a5568;">Fully refundable</div>
                </label>
            </div>
        </div>

        <!-- Damage Protection Section -->
        <div class="protection-section"
            style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid #e2e8f0;">
            <h2 class="section-title">Damage Protection</h2>
            <p class="section-description">Select protection level to reduce your liability for damages</p>

            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
                <button type="button" class="damage-protection-btn" data-protection="0" data-price="0"
                    style="flex: 1; min-width: 120px; padding: 20px; background: #ffffff; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #1a202c; margin-bottom: 8px;">₹0</div>
                    <div style="font-size: 12px; color: #4a5568; line-height: 1.4;">Pay full amount in case of any
                        damage. Minimum ₹5,000 for any small damage.</div>
                </button>
                <button type="button" class="damage-protection-btn" data-protection="277" data-price="277"
                    style="flex: 1; min-width: 120px; padding: 20px; background: #ffffff; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #1a202c; margin-bottom: 8px;">₹277</div>
                    <div style="font-size: 12px; color: #4a5568; line-height: 1.4;">Pay 70% of damage amount</div>
                </button>
                <button type="button" class="damage-protection-btn" data-protection="477" data-price="477"
                    style="flex: 1; min-width: 120px; padding: 20px; background: #ffffff; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #1a202c; margin-bottom: 8px;">₹477</div>
                    <div style="font-size: 12px; color: #4a5568; line-height: 1.4;">Pay 50% of damage amount</div>
                </button>
            </div>
        </div>

        <!-- Coupon Code Section -->
        <div class="coupon-section"
            style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid #e2e8f0;">
            <h2 class="section-title">Have a Coupon Code?</h2>
            <div style="display: flex; gap: 10px; align-items: flex-start;">
                <input type="text" id="couponCode" placeholder="Enter coupon code"
                    style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                    onkeypress="if(event.key === 'Enter') validateCoupon()">
                <button onclick="validateCoupon()" id="applyCouponBtn"
                    style="padding: 12px 24px; background: #3b82f6; color: #ffffff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; white-space: nowrap;">
                    Apply
                </button>
            </div>
            <div id="couponMessage" style="margin-top: 10px; font-size: 14px; display: none;"></div>
            <div id="appliedCoupon"
                style="margin-top: 10px; padding: 12px; background: #d1fae5; border-radius: 8px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #065f46;">Coupon Applied:</strong>
                        <span id="appliedCouponCode" style="color: #065f46; margin-left: 8px;"></span>
                        <span id="appliedCouponDiscount" style="color: #065f46; margin-left: 8px;"></span>
                    </div>
                    <button onclick="removeCoupon()"
                        style="background: none; border: none; color: #dc2626; cursor: pointer; font-weight: 600;">Remove</button>
                </div>
            </div>
        </div>

        <!-- Pricing Summary -->
        <div class="pricing-summary-section">
            <h2 class="section-title">Fare Breakup</h2>
            <ul class="pricing-items">
                <li class="pricing-item">
                    <span class="pricing-item-name">Car Price</span>
                    <span class="pricing-item-amount" id="carPriceAmount">
                        {% if pricing_breakdown %}₹{{ "{:,.0f}".format(pricing_breakdown.base_rental) }}{% else %}₹0{%
                        endif %}
                    </span>
                </li>
                <li class="pricing-item" id="damageProtectionItem">
                    <span class="pricing-item-name">Damage Protection</span>
                    <span class="pricing-item-amount" id="damageProtectionAmount">₹0</span>
                </li>
                <li class="pricing-item" id="discountItem" style="display: none;">
                    <span class="pricing-item-name" style="color: #059669;">Discount Applied</span>
                    <span class="pricing-item-amount" id="discountAmount" style="color: #059669;">-₹0</span>
                </li>
            </ul>
            <div class="pricing-total">
                <span class="pricing-total-label">Total Amount</span>
                <span class="pricing-total-amount" id="totalAmount">
                    {% if pricing_breakdown %}₹{{ "{:,.0f}".format(pricing_breakdown.total) }}{% else %}₹0{% endif %}
                </span>
            </div>
        </div>


        <!-- Phone Number Section (Required for Home Delivery) -->
        {% if home_delivery %}
        <div class="kyc-section" id="phoneSection">
            <h2 class="section-title">Contact Number Required</h2>
            <div class="kyc-warning">
                <div class="kyc-warning-text">
                    <strong>Required for Home Delivery:</strong> Please provide your phone number for delivery
                    coordination.
                </div>
            </div>
            <div class="form-group" style="margin-top: 20px;">
                <label for="phoneNumber"
                    style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a202c;">Phone Number *</label>
                <input type="tel" id="phoneNumber" name="phone" class="form-control"
                    placeholder="Enter your 10-digit phone number" pattern="[0-9]{10}" maxlength="10"
                    value="{{ user.phone if user.phone else '' }}" required>
                <small style="color: #64748b; font-size: 12px; margin-top: 5px; display: block;">
                    This number will be used by our delivery team to contact you
                </small>
            </div>
        </div>
        {% endif %}

        <!-- KYC Upload Section -->
        {% if not kyc_complete %}
        <div class="kyc-section">
            <h2 class="section-title">KYC Documents Required</h2>
            <div class="kyc-warning">
                <div class="kyc-warning-text">
                    <strong>Required:</strong> Please upload all KYC documents to proceed with payment.
                    All documents must be uploaded before you can complete the booking.
                </div>
            </div>
            <div class="kyc-documents">
                <!-- Aadhaar Front -->
                <div class="kyc-document-item">
                    <label class="kyc-document-label">Aadhaar Front</label>
                    {% if user.aadhaar_front %}
                    <div class="kyc-preview">
                        <img src="{{ user.aadhaar_front }}" alt="Aadhaar Front" onerror="this.style.display='none'">
                        <div class="kyc-upload-status uploaded">✓ Uploaded</div>
                    </div>
                    {% else %}
                    <div class="kyc-upload-area">
                        <input type="file" class="kyc-upload-input" accept=".jpg,.jpeg,.png,.pdf"
                            data-doc-type="aadhaar_front" id="aadhaarFront">
                        <label for="aadhaarFront" class="kyc-upload-button">Upload</label>
                    </div>
                    {% endif %}
                </div>

                <!-- Aadhaar Back -->
                <div class="kyc-document-item">
                    <label class="kyc-document-label">Aadhaar Back</label>
                    {% if user.aadhaar_back %}
                    <div class="kyc-preview">
                        <img src="{{ user.aadhaar_back }}" alt="Aadhaar Back" onerror="this.style.display='none'">
                        <div class="kyc-upload-status uploaded">✓ Uploaded</div>
                    </div>
                    {% else %}
                    <div class="kyc-upload-area">
                        <input type="file" class="kyc-upload-input" accept=".jpg,.jpeg,.png,.pdf"
                            data-doc-type="aadhaar_back" id="aadhaarBack">
                        <label for="aadhaarBack" class="kyc-upload-button">Upload</label>
                    </div>
                    {% endif %}
                </div>

                <!-- DL Front -->
                <div class="kyc-document-item">
                    <label class="kyc-document-label">Driving License Front</label>
                    {% if user.drivinglicense_front %}
                    <div class="kyc-preview">
                        <img src="{{ user.drivinglicense_front }}" alt="DL Front" onerror="this.style.display='none'">
                        <div class="kyc-upload-status uploaded">✓ Uploaded</div>
                    </div>
                    {% else %}
                    <div class="kyc-upload-area">
                        <input type="file" class="kyc-upload-input" accept=".jpg,.jpeg,.png,.pdf"
                            data-doc-type="dl_front" id="dlFront">
                        <label for="dlFront" class="kyc-upload-button">Upload</label>
                    </div>
                    {% endif %}
                </div>

                <!-- DL Back -->
                <div class="kyc-document-item">
                    <label class="kyc-document-label">Driving License Back</label>
                    {% if user.drivinglicense_back %}
                    <div class="kyc-preview">
                        <img src="{{ user.drivinglicense_back }}" alt="DL Back" onerror="this.style.display='none'">
                        <div class="kyc-upload-status uploaded">✓ Uploaded</div>
                    </div>
                    {% else %}
                    <div class="kyc-upload-area">
                        <input type="file" class="kyc-upload-input" accept=".jpg,.jpeg,.png,.pdf"
                            data-doc-type="dl_back" id="dlBack">
                        <label for="dlBack" class="kyc-upload-button">Upload</label>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Terms and Conditions Section -->
        <div class="terms-section">
            <div class="terms-header" onclick="toggleTerms()">
                <h3>Terms and Conditions & Risk Declaration</h3>
                <span class="terms-toggle" id="termsToggle">▼</span>
            </div>
            <div class="terms-content" id="termsContent">
                <div class="terms-body">
                    <div
                        style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                        <h1 style="font-size: 24px; font-weight: 700; color: #1a202c; margin-bottom: 10px;">GoGo Cars –
                            Terms and Conditions & Risk Declaration</h1>
                        <p style="font-size: 14px; color: #64748b; margin: 5px 0;">(operated by GoGo enterprises)</p>
                        <p style="font-size: 12px; color: #475569; margin: 5px 0;">Phone: 8121765714 | Email:
                            gogocars5477@gmail.com | GSTIN: 36BTQPG9657M1ZO</p>
                    </div>

                    <h2>1. Eligibility & Documentation</h2>
                    <p>Minimum driver age is 21 years (25 years for premium vehicles). A valid Indian Driving Licence
                        held for at least one year is mandatory. Original ID proof is required. Learner licences are not
                        accepted. Aadhar or passport is mandatory for renting a car.</p>

                    <h2>2. Rental Period</h2>
                    <p>Rental starts at pickup time and ends at return time. Late returns may attract hourly or full-day
                        charges. Extensions require prior approval.</p>
                    <h3>PENALTY FOR VEHICLE EXTENSION</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>CAR TYPE</th>
                                <th>PRICE</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Hatchback</td>
                                <td>Rs.80/hour</td>
                            </tr>
                            <tr>
                                <td>Sedan & MUV</td>
                                <td>Rs.100/hour</td>
                            </tr>
                            <tr>
                                <td>SUV</td>
                                <td>Rs.160/hour</td>
                            </tr>
                        </tbody>
                    </table>

                    <h2>3. Authorized Use</h2>
                    <p>The rented vehicle shall be operated strictly and exclusively by the renter whose details are
                        recorded in the agreement. No sharing, delegation, or substitution is permitted under any
                        circumstances. The vehicle shall not be used for any illegal, immoral, or unlawful activity
                        like:</p>
                    <ul>
                        <li>Racing, rallies, speed testing, or off-road driving</li>
                        <li>Commercial use including taxi, delivery, or sub-rental</li>
                        <li>Driving under influence of alcohol, drugs, or intoxicants</li>
                    </ul>
                    <p>Any violation or breach of this clause shall result in immediate termination of rental,
                        forfeiture of all paid amounts and deposits, and full civil and criminal liability on the
                        renter, without prejudice to the GoGo cars right to initiate legal proceedings.</p>

                    <h2>4. Vehicle Responsibility</h2>
                    <p>Vehicle must be returned in the same condition (normal wear excepted). Smoking or tobacco use
                        inside the vehicle is prohibited.</p>
                    <p><strong>Clutch problems and clutch plates burn and car break down due to clutch plates need be
                            taken care by the renter only.</strong> Before renting a car need to check car condition
                        complete responsibility by renter only.</p>

                    <h2>5. Fuel & Mileage</h2>
                    <p>Fuel level must be returned as provided. Mileage limits and excess charges apply as per booking.
                        No refund for extra fuel and no refund for fastag.</p>

                    <h2>6. Payments & Deposits</h2>
                    <p>All charges must be paid in advance. Security deposit refund will be processed within 7–10
                        working days post inspection. Bike + RC or laptop or cash (minimum 10000rs for small cars and it
                        will change depends on the car model premium cars – 30000rs min).</p>
                    <p>In the event that the vehicle is damaged during the rental period, the cost of repairs shall be
                        determined by GoGo Cars, and the security deposit shall be retained until all repairs have been
                        fully completed.</p>

                    <h2>7. Insurance & Liability</h2>
                    <ul>
                        <li>Vehicles are covered under basic motor insurance as per Indian law.</li>
                        <li>The renter is fully responsible for:
                            <ul>
                                <li>Insurance excess/deductible</li>
                                <li>Damage not covered by insurance</li>
                                <li>Damage caused by negligence or rule violations</li>
                            </ul>
                        </li>
                        <li>Insurance becomes void if:
                            <ul>
                                <li>Vehicle is driven by an unauthorized person</li>
                                <li>Driving under influence</li>
                                <li>Illegal or reckless use</li>
                            </ul>
                        </li>
                    </ul>

                    <h2>8. Traffic Violations</h2>
                    <p>The renter shall be solely and absolutely responsible for all traffic violations, challans,
                        tolls, parking charges, fines, penalties, and court summons, or statutory liabilities arising
                        during the rental period irrespective of when such notices are received. The GoGo cars is
                        authorized to recover such amounts from the security deposit or directly from the renter and
                        impose administrative and processing charges and also share renter details with authorities
                        without prior notice. In case of failure to settle such liabilities shall constitute material
                        breach of this agreement and may result in legal recovery proceedings.</p>

                    <h2>9. Downtime / Loss of Use Charges</h2>
                    <p>If the vehicle is damaged, seized, or unavailable due to renter's fault, a minimum downtime
                        charge of 1,000 per day shall apply until the vehicle is roadworthy, in addition to repair and
                        other costs. Premium cars 2000rs per day.</p>

                    <h2>10. Governing Law & Jurisdiction</h2>
                    <p>This agreement shall be governed by and construed exclusively in accordance with the laws of
                        India. Subject to arbitration clause herein, all courts, tribunals, and authorities other than
                        those situated within Andhra Pradesh are expressly excluded and exclusive jurisdiction shall
                        vest only within the jurisdiction of the Courts which are situated in GoGo Cars. The renter
                        irrevocably waives any objection to jurisdiction, forum non conveniens or territorial
                        competence.</p>

                    <h2>11. Cancellation Policy</h2>
                    <ul>
                        <li>Cancellation 48 hours before pickup: partial or full refund (as per booking policy).</li>
                        <li>Late cancellations or no-shows may result in forfeiture of booking amount.</li>
                        <li>If the id proofs submitted by the renter at the time of pick up is not satisfactory or if
                            the renter forgets to bring the ids mentioned in the terms during pick up, the booking will
                            be considered as last minute cancellation and no refund of the advance paid will be given.
                        </li>
                        <li>If the renter is found to be drunk or under any kind of intoxication at the time of pick up,
                            the booking will automatically be cancelled and no refund will be provided.</li>
                        <li>Any changes in the date of booking should be informed to us at least 48 hours before the
                            trip timing otherwise a 20% charge would be applied for changing the booking.</li>
                        <li>In case the renter needs to cancel the booking, the same has to be informed 48 hours before
                            the time of pickup and the booking will be cancelled with a charge of 30%. In case of the
                            cancellation being done within 48 hours prior to the time of pickup no refund will be given.
                        </li>
                        <li>If the renter needs to cancel or modify the booking within 24 hours from the time of pickup
                            no changes can be done to the same and no refund will be processed.</li>
                    </ul>

                    <h2>12. Termination of Rental</h2>
                    <p>GoGo Cars reserves the right to terminate the rental without refund if:</p>
                    <ul>
                        <li>Terms are violated</li>
                        <li>False information is provided</li>
                        <li>Vehicle is misused or abused</li>
                    </ul>

                    <h2>13. Personal Belongings</h2>
                    <p>GoGo Cars is not responsible for loss or damage to personal items left in the vehicle.</p>

                    <h2>14. Absolute Ownership & Prohibition of Illegal Mortgage</h2>
                    <p>The vehicle shall remain at all times the absolute, exclusive and undisputed property of GoGo
                        Cars. The renter holds the vehicle purely in trust and custody without acquiring any right,
                        title interest or claim of any nature. Any act or attempt of sale, pledge, mortgage, creation of
                        third party rights shall constitute criminal breach of trust and cheating, punishable under
                        Section 406 and 420 of IPC in addition to other applicable laws. GoGo Cars reserves the right to
                        initiate immediate criminal prosecution and civil recovery proceedings.</p>

                    <h2>15. Zero Tolerance for Illegal Use</h2>
                    <p>Use of the vehicle for any illegal, immoral, or unlawful purpose including smuggling,
                        transportation of contraband, criminal activities, or absconding shall result in immediate
                        termination and legal action. All losses, penalties, and legal consequences shall be borne
                        solely by the renter.</p>

                    <h2>16. Damage, Abuse & Negligence Policy</h2>
                    <p>The renter is fully responsible for all damages including mechanical, electrical, body, tyre,
                        wheel, interior, and cosmetic damages irrespective of fault. Damage assessment by GoGo Cars
                        shall be final and binding. Insurance does not cover damages caused due to rash driving,
                        negligence, water logging, clutch abuse, or misuse.</p>

                    <h2>17. Cheque Bounce & Financial Recovery Clause</h2>
                    <p>In case any cheque issued by the renter towards rental charges, damages, downtime, or recovery
                        costs is dishonoured, the renter shall be liable for prosecution under Section 138 of the
                        Negotiable Instruments Act, 1881. All legal costs, interest, and recovery expenses shall be
                        borne by the renter, without prejudice to GoGo Cars' right to recover dues by other legal means.
                    </p>

                    <h2>18. Accident, Injury & Death – Complete Indemnity</h2>
                    <p>The renter acknowledges that the vehicle is operated entirely at the renters own risk. GoGo Cars,
                        its proprietor, employees, agents or representatives shall bear no liability whatsoever for
                        accidents, injury, disability, death or third party claims. The renter agrees to fully indemnify
                        and hold harmless GoGo cars from all claims, compensation, damages, costs and legal proceedings
                        whether civil, criminal or statutory including third party and governmental claims.</p>

                    <h2>19. Seizure, Police Case & Legal Costs</h2>
                    <p>If the vehicle is seized, impounded, detained or involved in any police, criminal, regulatory or
                        court proceedings due to the renter acts or omissions, the renter shall be solely responsible
                        for legal representation and advocate fees, Court costs, penalties, fines and settlements, loss
                        of business, downtime and reputational damage. The renter shall reimburse GoGo cars on demand,
                        and failure to do so shall entitle GoGo cars to initiate recovery and prosecution proceedings.
                    </p>

                    <h2>20. Arbitration Clause (Fast Recovery)</h2>
                    <p>All disputes, claims, or differences arising out of or relating to this agreement shall be
                        referred to sole arbitration under the Arbitration and Conciliation Act, 1996. The arbitrator
                        shall be appointed exclusively by GoGo cars. The seat and Venue of arbitration shall be
                        Mangalagiri or Guntur. The arbitral award shall be final, binding, enforceable, and non
                        appealable except as permitted under law.</p>

                    <h2>21. Jurisdiction</h2>
                    <p>Subject to the arbitration clause, all legal proceedings shall lie exclusively within the
                        jurisdiction of the Andhra Pradesh High Court, Amaravati only. The renter expressly waives any
                        right to initiate proceedings in any other court or forum and agrees that such action shall be
                        void and unenforceable.</p>
                    <p><strong>Or</strong></p>
                    <p>All legal proceedings shall lie exclusively within the jurisdiction of the corporate office
                        location. The renter expressly waives any right to initiate proceedings in any other court or
                        forum and agrees that such action shall be void and unenforceable.</p>

                    <div
                        style="margin-top: 30px; padding: 20px; background: #fff5f2; border-left: 4px solid #ff6b35; border-radius: 8px;">
                        <h2 style="color: #1a202c; margin-top: 0;">Risk & Liability Declaration</h2>
                        <p>I, the undersigned renter, acknowledge that I am renting and operating the vehicle from GoGo
                            Cars entirely at my own risk.</p>
                        <p>I agree that in case of any accident, injury, disability, or death involving the rented
                            vehicle, GoGo Cars, its owner, employees, or staff shall not be held responsible under any
                            circumstances.</p>
                        <p>I accept full civil, criminal, and legal liability for all consequences arising from use of
                            the vehicle.</p>
                        <p>I further agree to pay downtime / loss-of-use charges of minimum 1,000 per day if the vehicle
                            becomes unusable due to accident, negligence, seizure, or misuse during my rental period.
                        </p>
                        <p>I confirm that I possess a valid driving licence, am medically fit to drive, and will comply
                            with all traffic laws.</p>
                        <p><strong>I have read and accepted this agreement voluntarily and without coercion.</strong>
                        </p>
                    </div>

                    <div
                        style="margin-top: 30px; padding: 15px; background: #f7fafc; border-radius: 8px; font-size: 12px; color: #475569;">
                        <h3 style="color: #1a202c; margin-top: 0;">Corporate Office Locations:</h3>
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                            <div>
                                <p><strong>Parking - 1</strong></p>
                                <p>Flot No -406, Block No-1<br>
                                    Srinivasam Apartments,<br>
                                    KLU Road, Kunchanapalli,<br>
                                    Tadepalli, Guntur, A. P -522501</p>
                                <p>+91 8121765714</p>
                            </div>
                            <div>
                                <p><strong>Parking - 2</strong></p>
                                <p>Road No – 8, plot no 146,<br>
                                    Ayyappa Society, Madhapur,<br>
                                    Hyderabad, Telangana - 500081</p>
                                <p>+91 9052775477</p>
                            </div>
                            <div>
                                <p><strong>Corporate office</strong></p>
                                <p>5 – 307/3, Opp Power sub station<br>
                                    Rtc, colony, Chilakaluripeta,<br>
                                    Guntur, Andrapradesh - 522616</p>
                                <p>+91 9133135477</p>
                            </div>
                        </div>
                        <p style="margin-top: 15px; text-align: center;">
                            <strong>GST – 36BTQPG9657M1ZO</strong><br>
                            gogocars5477@gmail.com | +91 8121765714 | www.gogocar.in
                        </p>
                    </div>
                </div>
            </div>
            <div class="terms-checkbox-container">
                <input type="checkbox" id="termsAcceptCheckbox" required>
                <label for="termsAcceptCheckbox">
                    I have read, understood, and agree to the Terms and Conditions & Risk Declaration stated above. I
                    acknowledge that I am renting the vehicle entirely at my own risk and accept full liability for all
                    consequences.
                </label>
            </div>
        </div>


        <!-- Payment Section -->
        <div class="payment-section">
            <div class="payment-info">
                <div class="payment-label">Total Amount</div>
                <div class="payment-description" id="paymentDescription">
                    {% if not kyc_complete %}
                    Please upload all KYC documents to proceed with payment.
                    {% else %}
                    Complete your booking by proceeding to payment.
                    {% endif %}
                </div>
            </div>
            <button class="pay-button" id="payButton" {% if not kyc_complete %}disabled{% endif %}
                onclick="if (!checkTermsAccepted()) { alert('Please accept the Terms and Conditions to proceed.'); document.getElementById('termsAcceptCheckbox').focus(); return false; }">
                {% if kyc_complete %}
                Pay Now
                {% else %}
                Complete KYC First
                {% endif %}
            </button>
        </div>
    </div>

    <script>
        // Car data from server (only for display, not for calculations)
        const carId = {{ car.id if car else 'null' }};
        const hours = {{ hours if hours else 1 }};
        const kycComplete = {{ 'true' if kyc_complete else 'false' }};
        const missingDocuments = {{ missing_documents | tojson if missing_documents else '[]' }};

        // Current pricing data (will be fetched from backend)
        let currentPricing = null;
        let appliedCoupon = null;
        let selectedDamageProtection = 0; // 0, 277, or 477
        let selectedDeposit = 'bike_rc'; // bike_rc, laptop, cheque, cash

        // Damage protection buttons
        const damageProtectionButtons = document.querySelectorAll('.damage-protection-btn');
        damageProtectionButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                // Remove selected class from all buttons
                damageProtectionButtons.forEach(b => b.classList.remove('selected'));
                // Add selected class to clicked button
                this.classList.add('selected');
                // Update selected protection
                selectedDamageProtection = parseInt(this.getAttribute('data-protection'));
                updatePricing();
            });
        });

        // Set default selection (₹0)
        if (damageProtectionButtons.length > 0) {
            damageProtectionButtons[0].classList.add('selected');
        }

        // Deposit option selection
        const depositOptions = document.querySelectorAll('input[name="deposit"]');
        const depositCards = document.querySelectorAll('.deposit-option-card');

        depositCards.forEach((card, index) => {
            card.addEventListener('click', function () {
                // Trigger the radio button
                if (depositOptions[index]) {
                    depositOptions[index].checked = true;
                    depositOptions[index].dispatchEvent(new Event('change'));
                }
            });
        });

        depositOptions.forEach((option, index) => {
            option.addEventListener('change', function () {
                selectedDeposit = this.value;
                // Update card styling
                depositCards.forEach(card => card.classList.remove('selected'));
                if (depositCards[index]) {
                    depositCards[index].classList.add('selected');
                }
            });
        });

        // Set default selected deposit card
        if (depositCards.length > 0 && depositOptions[0]) {
            depositOptions[0].checked = true;
            depositCards[0].classList.add('selected');
        }

        // Initial pricing load
        async function loadInitialPricing() {
            await updatePricing();
        }

        // Load pricing on page load
        loadInitialPricing();

        // Coupon management functions
        async function validateCoupon() {
            const couponCode = document.getElementById('couponCode').value.trim().toUpperCase();
            const messageDiv = document.getElementById('couponMessage');
            const applyBtn = document.getElementById('applyCouponBtn');

            if (!couponCode) {
                messageDiv.style.display = 'block';
                messageDiv.style.color = '#dc2626';
                messageDiv.textContent = 'Please enter a coupon code';
                return;
            }

            applyBtn.disabled = true;
            applyBtn.textContent = 'Validating...';
            messageDiv.style.display = 'none';

            // Recalculate pricing with coupon - backend will validate
            await updatePricing(couponCode);
        }

        function removeCoupon() {
            appliedCoupon = null;
            document.getElementById('appliedCoupon').style.display = 'none';
            document.getElementById('couponCode').value = '';
            document.getElementById('couponMessage').style.display = 'none';
            updatePricing();
        }

        // Update pricing by calling backend API
        async function updatePricing(couponCode = null) {
            try {
                // Build request body
                const requestBody = {
                    car_id: carId,
                    hours: hours,
                    damage_protection: selectedDamageProtection
                };

                if (couponCode) {
                    requestBody.coupon_code = couponCode;
                } else if (appliedCoupon) {
                    requestBody.coupon_code = appliedCoupon.coupon_code;
                }

                const response = await fetch('/payments/calculate-price', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('Failed to calculate price');
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.detail || 'Failed to calculate price');
                }

                currentPricing = result.pricing;

                // Update applied coupon if coupon was used
                if (result.coupon_applied && result.coupon_id) {
                    appliedCoupon = {
                        coupon_id: result.coupon_id,
                        coupon_code: couponCode || (appliedCoupon ? appliedCoupon.coupon_code : ''),
                        discount_amount: result.pricing.discount
                    };
                    document.getElementById('appliedCouponCode').textContent = appliedCoupon.coupon_code;
                    document.getElementById('appliedCouponDiscount').textContent = `-₹${result.pricing.discount.toLocaleString('en-IN')}`;
                    document.getElementById('appliedCoupon').style.display = 'block';
                    document.getElementById('couponCode').value = '';
                    document.getElementById('couponMessage').style.display = 'none';
                } else if (couponCode) {
                    // Coupon validation failed
                    const messageDiv = document.getElementById('couponMessage');
                    messageDiv.style.display = 'block';
                    messageDiv.style.color = '#dc2626';
                    messageDiv.textContent = 'Invalid coupon code';
                }

                // Update display with backend-calculated values
                document.getElementById('carPriceAmount').textContent = `₹${currentPricing.base_rental.toLocaleString('en-IN')}`;

                // Update damage protection amount
                const damageProtectionItem = document.getElementById('damageProtectionItem');
                const damageProtectionAmount = document.getElementById('damageProtectionAmount');
                if (damageProtectionItem && damageProtectionAmount) {
                    damageProtectionAmount.textContent = `₹${selectedDamageProtection.toLocaleString('en-IN')}`;
                }

                // Show/hide discount item
                const discountItem = document.getElementById('discountItem');
                const discountAmount = document.getElementById('discountAmount');
                if (currentPricing.discount > 0) {
                    discountItem.style.display = 'flex';
                    discountAmount.textContent = `-₹${currentPricing.discount.toLocaleString('en-IN')}`;
                } else {
                    discountItem.style.display = 'none';
                }

                document.getElementById('totalAmount').textContent = `₹${currentPricing.total.toLocaleString('en-IN')}`;

                // Re-enable apply button
                const applyBtn = document.getElementById('applyCouponBtn');
                if (applyBtn) {
                    applyBtn.disabled = false;
                    applyBtn.textContent = 'Apply';
                }

            } catch (error) {
                console.error('Error updating pricing:', error);
                const messageDiv = document.getElementById('couponMessage');
                if (messageDiv && couponCode) {
                    messageDiv.style.display = 'block';
                    messageDiv.style.color = '#dc2626';
                    messageDiv.textContent = 'Error calculating price. Please try again.';
                }

                // Re-enable apply button
                const applyBtn = document.getElementById('applyCouponBtn');
                if (applyBtn) {
                    applyBtn.disabled = false;
                    applyBtn.textContent = 'Apply';
                }
            }
        }

        // KYC Upload handlers
        document.querySelectorAll('.kyc-upload-input').forEach(input => {
            input.addEventListener('change', async function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const docType = this.getAttribute('data-doc-type');
                const formData = new FormData();
                formData.append('file', file);
                formData.append('document_type', docType);

                const button = this.nextElementSibling;
                const originalText = button.textContent;
                button.textContent = 'Uploading...';
                button.disabled = true;

                try {
                    const response = await fetch('/auth/kyc/upload', {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Reload page to show uploaded document
                        location.reload();
                    } else {
                        alert('Upload failed: ' + (result.detail || 'Unknown error'));
                        button.textContent = originalText;
                        button.disabled = false;
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed. Please try again.');
                    button.textContent = originalText;
                    button.disabled = false;
                }
            });
        });

        // Terms toggle function
        function toggleTerms() {
            const content = document.getElementById('termsContent');
            const toggle = document.getElementById('termsToggle');
            content.classList.toggle('expanded');
            toggle.classList.toggle('expanded');
        }

        // Check terms acceptance before payment
        function checkTermsAccepted() {
            const checkbox = document.getElementById('termsAcceptCheckbox');
            return checkbox && checkbox.checked;
        }

        // Update pay button state based on terms acceptance
        function updatePayButtonState() {
            const payButton = document.getElementById('payButton');
            const termsCheckbox = document.getElementById('termsAcceptCheckbox');
            if (payButton && termsCheckbox) {
                if (!kycComplete) {
                    payButton.disabled = true;
                } else if (!termsCheckbox.checked) {
                    payButton.disabled = true;
                } else {
                    payButton.disabled = false;
                }
            }
        }

        // Listen for terms checkbox changes
        document.getElementById('termsAcceptCheckbox')?.addEventListener('change', function () {
            updatePayButtonState();
        });

        // Pay button handler
        document.getElementById('payButton')?.addEventListener('click', async function () {
            if (!kycComplete) {
                alert('Please upload all KYC documents first.');
                return;
            }

            // Check if terms are accepted
            if (!checkTermsAccepted()) {
                alert('Please read and accept the Terms and Conditions & Risk Declaration to proceed with payment.');
                // Expand terms section if collapsed
                const content = document.getElementById('termsContent');
                if (!content.classList.contains('expanded')) {
                    toggleTerms();
                }
                // Scroll to terms section
                document.querySelector('.terms-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            // Check phone number if home delivery is selected
            const homeDelivery = {{ 'true' if home_delivery else 'false' }
        };
        if (homeDelivery) {
            const phoneInput = document.getElementById('phoneNumber');
            if (phoneInput) {
                const phoneNumber = phoneInput.value.trim();
                if (!phoneNumber || phoneNumber.length !== 10 || !/^[0-9]{10}$/.test(phoneNumber)) {
                    alert('Please enter a valid 10-digit phone number for home delivery.');
                    phoneInput.focus();
                    return;
                }

                // Update phone number if it's different from current
                const currentPhone = '{{ user.phone if user.phone else "" }}';
                if (phoneNumber !== currentPhone) {
                    try {
                        const updateResponse = await fetch('/auth/update-phone', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({ phone: phoneNumber })
                        });

                        if (!updateResponse.ok) {
                            const errorData = await updateResponse.json();
                            alert('Error updating phone number: ' + (errorData.detail || 'Please try again'));
                            return;
                        }
                    } catch (error) {
                        console.error('Error updating phone:', error);
                        alert('Error updating phone number. Please try again.');
                        return;
                    }
                }
            }
        }

        const button = this;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = 'Processing...';

        try {
            // Ensure we have current pricing from backend
            if (!currentPricing) {
                await updatePricing();
            }

            // Use backend-calculated values
            const baseRental = currentPricing.base_rental;
            const discount = currentPricing.discount || 0;
            const total = currentPricing.total;

            // Get delivery info from sessionStorage or template
            const deliveryAddress = sessionStorage.getItem('delivery_address') || '{{ delivery_address if delivery_address else "" }}';
            const deliveryLatitude = sessionStorage.getItem('delivery_latitude') || '{{ delivery_latitude if delivery_latitude else "" }}';
            const deliveryLongitude = sessionStorage.getItem('delivery_longitude') || '{{ delivery_longitude if delivery_longitude else "" }}';

            // Collect booking data
            const bookingData = {
                car_id: carId,
                pickup_datetime: '{{ pickup_datetime }}',
                end_datetime: '{{ end_datetime }}',
                hours: hours,
                damage_protection: selectedDamageProtection,
                deposit_type: selectedDeposit,
                base_rental: baseRental,
                discount: discount,
                total: total,
                coupon_id: appliedCoupon ? appliedCoupon.coupon_id : null,
                home_delivery: homeDelivery,
                delivery_address: deliveryAddress,
                delivery_latitude: deliveryLatitude,
                delivery_longitude: deliveryLongitude
            };

            // Create temporary order
            const formData = new FormData();
            formData.append('car_id', bookingData.car_id);
            formData.append('pickup_datetime', bookingData.pickup_datetime);
            formData.append('end_datetime', bookingData.end_datetime);
            formData.append('hours', bookingData.hours);
            formData.append('damage_protection', bookingData.damage_protection);
            formData.append('deposit_type', bookingData.deposit_type);
            formData.append('base_rental', bookingData.base_rental);
            formData.append('discount', bookingData.discount);
            if (bookingData.coupon_id) {
                formData.append('coupon_id', bookingData.coupon_id);
            }
            formData.append('total', bookingData.total);
            formData.append('home_delivery', String(bookingData.home_delivery));
            if (bookingData.delivery_address) {
                formData.append('delivery_address', bookingData.delivery_address);
            }
            if (bookingData.delivery_latitude) {
                formData.append('delivery_latitude', bookingData.delivery_latitude);
            }
            if (bookingData.delivery_longitude) {
                formData.append('delivery_longitude', bookingData.delivery_longitude);
            }

            const response = await fetch('/payments/create-temp-order', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });

            const result = await response.json();

            if (result.success && result.temp_order_id) {
                // Redirect to payment gateway with coupon_id and delivery info if applicable
                let paymentUrl = `/payments/create?order_id=${result.temp_order_id}`;
                if (appliedCoupon && appliedCoupon.coupon_id) {
                    paymentUrl += `&coupon_id=${appliedCoupon.coupon_id}`;
                }
                // Add damage protection and deposit type
                paymentUrl += `&damage_protection=${selectedDamageProtection}`;
                paymentUrl += `&deposit_type=${encodeURIComponent(selectedDeposit)}`;
                // Add delivery info to URL if available
                if (result.delivery_info && result.delivery_info.home_delivery) {
                    paymentUrl += `&home_delivery=true`;
                    if (result.delivery_info.delivery_address) {
                        paymentUrl += `&delivery_address=${encodeURIComponent(result.delivery_info.delivery_address)}`;
                    }
                    if (result.delivery_info.delivery_latitude && result.delivery_info.delivery_longitude) {
                        paymentUrl += `&delivery_latitude=${result.delivery_info.delivery_latitude}&delivery_longitude=${result.delivery_info.delivery_longitude}`;
                    }
                }
                window.location.href = paymentUrl;
            } else {
                throw new Error(result.detail || 'Failed to create order');
            }
        } catch (error) {
            console.error('Payment error:', error);
            alert('Failed to initiate payment: ' + (error.message || 'Unknown error. Please try again.'));
            button.disabled = false;
            button.innerHTML = originalText;
        }
        });

        // Initialize
        updatePricing();
        updatePayButtonState(); // Set initial button state
    </script>
</body>

</html>