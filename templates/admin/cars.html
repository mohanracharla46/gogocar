{% extends "admin/base.html" %}

{% block title %}Cars Management - Admin Panel{% endblock %}

{% block page_title %}Cars Management{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header" style="flex-wrap: wrap; gap: 20px;">
        <h3><i class="fas fa-car-side" style="color: var(--primary); margin-right: 12px;"></i>Fleet Management</h3>
        <div
            style="display: flex; gap: 15px; flex-grow: 1; min-width: 300px; justify-content: flex-end; align-items: center;">
            <div style="position: relative; flex-grow: 1; max-width: 400px;">
                <i class="fas fa-search" style="position: absolute; left: 15px; top: 14px; color: var(--gray);"></i>
                <input type="text" id="searchInput" class="form-control" placeholder="Search by brand or model..."
                    style="padding-left: 45px; margin-bottom: 0;">
            </div>
            <a href="/admin/cars/create" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add New Car
            </a>
        </div>
    </div>

    <div
        style="margin-bottom: 30px; display: flex; gap: 15px; align-items: center; background: #f8fafc; padding: 20px; border-radius: 20px; border: 1px solid var(--border);">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-filter" style="color: var(--primary); font-size: 14px;"></i>
            <span style="font-weight: 700; font-size: 14px; color: var(--dark);">Quick Filters:</span>
        </div>
        <select id="filterActive" class="form-control" style="max-width: 160px; margin-bottom: 0;">
            <option value="">All Status</option>
            <option value="true">Active Only</option>
            <option value="false">Inactive Only</option>
        </select>
        <select id="filterType" class="form-control" style="max-width: 160px; margin-bottom: 0;">
            <option value="">All Types</option>
            <option value="SUV">SUV</option>
            <option value="SEDAN">SEDAN</option>
            <option value="HATCHBACK">HATCHBACK</option>
        </select>
        <button onclick="loadCars()" class="btn btn-outline" style="padding: 10px 20px;">
            Apply Filters
        </button>
    </div>

    <div id="loadingSpinner" class="spinner" style="display: none; margin: 50px auto;"></div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Car Identity</th>
                    <th>Type</th>
                    <th>Price / Day</th>
                    <th>Key Features</th>
                    <th>Visibility</th>
                    <th style="text-align: right;">Quick Actions</th>
                </tr>
            </thead>
            <tbody id="carsTable">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 60px; color: var(--gray);">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px;">Synchronizing fleet data...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="pagination" id="pagination"></div>
</div>

<script>
    let currentPage = 1;
    const pageSize = 20;

    async function loadCars() {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const carsTable = document.getElementById('carsTable');

        loadingSpinner.style.display = 'block';
        carsTable.innerHTML = '<tr><td colspan="8" style="text-align: center;">Loading...</td></tr>';

        try {
            const activeFilter = document.getElementById('filterActive').value;
            const typeFilter = document.getElementById('filterType').value;
            const search = document.getElementById('searchInput').value;

            let url = `/cars?page=${currentPage}&page_size=${pageSize}`;
            if (activeFilter === 'true') url += '&active_only=true';
            if (typeFilter) url += `&car_type=${typeFilter}`;

            const data = await apiCall(url);

            if (data.items && data.items.length > 0) {
                let filtered = data.items;

                // Client-side search
                if (search) {
                    filtered = filtered.filter(car =>
                        car.brand.toLowerCase().includes(search.toLowerCase()) ||
                        car.car_model.toLowerCase().includes(search.toLowerCase())
                    );
                }

                carsTable.innerHTML = filtered.map(car => {
                    const images = car.images ? (typeof car.images === 'string' ? car.images.split(',') : []) : [];
                    const imageUrl = images[0] || '/static/img/landing.png';

                    let featuresDisplay = '<span style="color: var(--gray);">-</span>';
                    if (car.features) {
                        if (Array.isArray(car.features) && car.features.length > 0) {
                            featuresDisplay = car.features.slice(0, 2).map(f => `<span style="font-size: 11px; background: #f1f5f9; padding: 2px 8px; border-radius: 4px; border: 1px solid #e2e8f0; margin-right: 4px;">${f}</span>`).join('') + (car.features.length > 2 ? '...' : '');
                        } else if (typeof car.features === 'string' && car.features.trim()) {
                            featuresDisplay = `<span style="font-size: 11px; background: #f1f5f9; padding: 2px 8px; border-radius: 4px;">${car.features.slice(0, 20)}...</span>`;
                        }
                    }

                    return `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="position: relative;">
                                        <img src="${imageUrl}" alt="${car.brand}" 
                                             style="width: 80px; height: 50px; object-fit: cover; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                                        <div style="position: absolute; -top: 8px; -left: 8px; background: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 800; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05);">ID</div>
                                    </div>
                                    <div style="display: flex; flex-direction: column;">
                                        <span style="font-weight: 800; color: var(--dark); font-size: 15px;">${car.brand}</span>
                                        <span style="font-size: 12px; color: var(--gray);">${car.car_model} <span style="margin: 0 5px; opacity: 0.3;">|</span> #${car.id}</span>
                                    </div>
                                </div>
                            </td>
                            <td><span class="badge badge-info" style="background: rgba(59, 130, 246, 0.1); color: #2563eb;">${car.car_type || '-'}</span></td>
                            <td><span style="font-weight: 800; color: var(--primary); font-size: 15px;">â‚¹${(car.base_price || 0).toLocaleString('en-IN')}</span></td>
                            <td>${featuresDisplay}</td>
                            <td>
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <span class="badge badge-${car.active ? 'success' : 'danger'}">
                                        <i class="fas fa-${car.active ? 'check-circle' : 'times-circle'}" style="margin-right: 5px;"></i>
                                        ${car.active ? 'Visible' : 'Hidden'}
                                    </span>
                                    <span class="badge ${car.is_booked ? 'badge-warning' : 'badge-success'}" style="${car.is_booked ? 'background: rgba(245, 158, 11, 0.1); color: #d97706;' : 'background: rgba(16, 185, 129, 0.1); color: #059669;'}">
                                        <i class="fas fa-${car.is_booked ? 'lock' : 'lock-open'}" style="margin-right: 5px;"></i>
                                        ${car.is_booked ? 'Booked' : 'Available'}
                                    </span>
                                </div>
                            </td>
                            <td style="text-align: right;">
                                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                    <a href="/admin/cars/${car.id}/edit" class="btn btn-outline" style="padding: 8px; width: 36px; height: 36px; justify-content: center;" title="Edit Car">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button onclick="toggleCarActive(${car.id})" class="btn ${car.active ? 'btn-outline' : 'btn-primary'}" 
                                            style="padding: 8px; width: 36px; height: 36px; justify-content: center; ${car.active ? 'color: var(--warning); border-color: var(--warning);' : ''}" title="${car.active ? 'Deactivate' : 'Activate'}">
                                        <i class="fas fa-${car.active ? 'eye-slash' : 'eye'}"></i>
                                    </button>
                                    <button onclick="toggleCarBooked(${car.id})" class="btn btn-outline" 
                                            style="padding: 8px; width: 36px; height: 36px; justify-content: center; color: #d97706; border-color: rgba(217, 119, 6, 0.2);" title="${car.is_booked ? 'Mark Available' : 'Mark Booked'}">
                                        <i class="fas fa-${car.is_booked ? 'unlock' : 'calendar-check'}"></i>
                                    </button>
                                    <button onclick="deleteCar(${car.id})" class="btn btn-outline" 
                                            style="padding: 8px; width: 36px; height: 36px; justify-content: center; color: var(--danger); border-color: rgba(239, 68, 68, 0.2);" title="Delete Car">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Update pagination
                updatePagination(data);
            } else {
                carsTable.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <i class="fas fa-car" style="font-size: 48px; color: var(--gray); margin-bottom: 15px; display: block;"></i>
                            <p style="color: var(--gray); font-size: 16px; margin: 0;">No cars yet</p>
                            <p style="color: var(--gray); font-size: 14px; margin-top: 5px;">Click "Add New Car" to create your first car</p>
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Error loading cars:', error);
            const errorMsg = error.message || 'Unknown error occurred';
            carsTable.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: var(--danger);">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                        <p style="font-size: 16px; margin: 0;">Error loading cars</p>
                        <small style="font-size: 14px; margin-top: 5px; display: block;">${errorMsg}</small>
                        <button onclick="loadCars()" class="btn btn-primary" style="margin-top: 15px;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </td>
                </tr>
            `;
            showAlert('Error loading cars: ' + errorMsg, 'danger');
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }

    function updatePagination(data) {
        const pagination = document.getElementById('pagination');
        const totalPages = data.total_pages || 1;

        let html = '';

        // Previous button
        html += `<button onclick="changePage(${currentPage - 1})" ${!data.has_prev ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i> Previous
        </button>`;

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `<button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += '<span>...</span>';
            }
        }

        // Next button
        html += `<button onclick="changePage(${currentPage + 1})" ${!data.has_next ? 'disabled' : ''}>
            Next <i class="fas fa-chevron-right"></i>
        </button>`;

        pagination.innerHTML = html;
    }

    function changePage(page) {
        currentPage = page;
        loadCars();
    }

    async function toggleCarActive(carId) {
        if (!confirm('Are you sure you want to change the car status?')) return;

        try {
            const car = await apiCall(`/cars/${carId}/toggle-active`, {
                method: 'POST'
            });

            showAlert(`Car ${car.active ? 'activated' : 'deactivated'} successfully`, 'success');
            loadCars();
        } catch (error) {
            showAlert('Error updating car: ' + error.message, 'danger');
        }
    }

    async function toggleCarBooked(carId) {
        if (!confirm('Are you sure you want to change the booking status of this car?')) return;

        try {
            const car = await apiCall(`/admin/api/cars/${carId}/toggle-booked`, {
                method: 'POST'
            });

            showAlert(`Car marked as ${car.is_booked ? 'booked' : 'available'} successfully`, 'success');
            loadCars();
        } catch (error) {
            showAlert('Error updating car booking status: ' + (error.message || 'Unknown error'), 'danger');
        }
    }

    async function deleteCar(carId) {
        if (!confirm('Are you sure you want to delete this car? This action cannot be undone.')) return;

        try {
            await apiCall(`/cars/${carId}`, {
                method: 'DELETE'
            });

            showAlert('Car deleted successfully', 'success');
            loadCars();
        } catch (error) {
            showAlert('Error deleting car: ' + error.message, 'danger');
        }
    }

    // Search on Enter key
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            loadCars();
        }
    });

    // Don't call loadCars() here - it will be called in extra_js block after apiCall is loaded
</script>
{% endblock %}

{% block extra_js %}
<script>
    // Load cars on page load
    loadCars();
</script>
{% endblock %}