{% extends "admin/base.html" %}

{% block title %}Cars Management - Admin Panel{% endblock %}

{% block page_title %}Cars Management{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-car-side" style="color: var(--primary); margin-right: 10px;"></i>All Cars</h3>
        <a href="/admin/cars/create" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add New Car
        </a>
    </div>
    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
        <input type="text" id="searchInput" class="form-control" placeholder="Search cars..." style="max-width: 300px;">
        <select id="filterActive" class="form-control" style="max-width: 200px;">
            <option value="">All Cars</option>
            <option value="true">Active Only</option>
            <option value="false">Inactive Only</option>
        </select>
        <select id="filterType" class="form-control" style="max-width: 200px;">
            <option value="">All Types</option>
            <option value="SUV">SUV</option>
            <option value="SEDAN">SEDAN</option>
            <option value="HATCHBACK">HATCHBACK</option>
        </select>
        <button onclick="loadCars()" class="btn btn-primary">
            <i class="fas fa-filter"></i> Filter
        </button>
    </div>
    <div id="loadingSpinner" class="spinner" style="display: none;"></div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Image</th>
                    <th>Brand & Model</th>
                    <th>Type</th>
                    <th>Price/Day</th>
                    <th>Features</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="carsTable">
                <tr>
                    <td colspan="8" style="text-align: center; color: var(--gray);">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="pagination" id="pagination"></div>
</div>

<script>
    let currentPage = 1;
    const pageSize = 20;

    async function loadCars() {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const carsTable = document.getElementById('carsTable');

        loadingSpinner.style.display = 'block';
        carsTable.innerHTML = '<tr><td colspan="8" style="text-align: center;">Loading...</td></tr>';

        try {
            const activeFilter = document.getElementById('filterActive').value;
            const typeFilter = document.getElementById('filterType').value;
            const search = document.getElementById('searchInput').value;

            let url = `/cars?page=${currentPage}&page_size=${pageSize}`;
            if (activeFilter === 'true') url += '&active_only=true';
            if (typeFilter) url += `&car_type=${typeFilter}`;

            const data = await apiCall(url);

            if (data.items && data.items.length > 0) {
                let filtered = data.items;

                // Client-side search
                if (search) {
                    filtered = filtered.filter(car =>
                        car.brand.toLowerCase().includes(search.toLowerCase()) ||
                        car.car_model.toLowerCase().includes(search.toLowerCase())
                    );
                }

                carsTable.innerHTML = filtered.map(car => {
                    const images = car.images ? (typeof car.images === 'string' ? car.images.split(',') : []) : [];
                    const imageUrl = images[0] || '/static/img/landing.png';

                    // Handle features - could be array, string, or null
                    let featuresDisplay = '<span style="color: var(--gray);">-</span>';
                    if (car.features) {
                        if (Array.isArray(car.features) && car.features.length > 0) {
                            featuresDisplay = car.features.slice(0, 2).join(', ') + (car.features.length > 2 ? '...' : '');
                        } else if (typeof car.features === 'string' && car.features.trim()) {
                            featuresDisplay = car.features;
                        }
                    }

                    return `
                        <tr>
                            <td>#${car.id}</td>
                            <td>
                                <img src="${imageUrl}" alt="${car.brand} ${car.car_model}" 
                                     style="width: 60px; height: 40px; object-fit: cover; border-radius: 6px;">
                            </td>
                            <td>
                                <strong>${car.brand}</strong><br>
                                <small style="color: var(--gray);">${car.car_model}</small>
                            </td>
                            <td><span class="badge badge-info">${car.car_type || '-'}</span></td>
                            <td>â‚¹${(car.base_price || 0).toLocaleString('en-IN')}</td>
                            <td>${featuresDisplay}</td>
                            <td>
                                <span class="badge badge-${car.active ? 'success' : 'danger'}">
                                    ${car.active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 5px;">
                                    <a href="/admin/cars/${car.id}/edit" class="btn btn-outline" style="padding: 5px 10px; font-size: 12px;">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button onclick="toggleCarActive(${car.id})" class="btn ${car.active ? 'btn-warning' : 'btn-success'}" 
                                            style="padding: 5px 10px; font-size: 12px;">
                                        <i class="fas fa-${car.active ? 'ban' : 'check'}"></i>
                                    </button>
                                    <button onclick="deleteCar(${car.id})" class="btn btn-danger" 
                                            style="padding: 5px 10px; font-size: 12px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Update pagination
                updatePagination(data);
            } else {
                carsTable.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <i class="fas fa-car" style="font-size: 48px; color: var(--gray); margin-bottom: 15px; display: block;"></i>
                            <p style="color: var(--gray); font-size: 16px; margin: 0;">No cars yet</p>
                            <p style="color: var(--gray); font-size: 14px; margin-top: 5px;">Click "Add New Car" to create your first car</p>
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Error loading cars:', error);
            const errorMsg = error.message || 'Unknown error occurred';
            carsTable.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: var(--danger);">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                        <p style="font-size: 16px; margin: 0;">Error loading cars</p>
                        <small style="font-size: 14px; margin-top: 5px; display: block;">${errorMsg}</small>
                        <button onclick="loadCars()" class="btn btn-primary" style="margin-top: 15px;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </td>
                </tr>
            `;
            showAlert('Error loading cars: ' + errorMsg, 'danger');
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }

    function updatePagination(data) {
        const pagination = document.getElementById('pagination');
        const totalPages = data.total_pages || 1;

        let html = '';

        // Previous button
        html += `<button onclick="changePage(${currentPage - 1})" ${!data.has_prev ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i> Previous
        </button>`;

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `<button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += '<span>...</span>';
            }
        }

        // Next button
        html += `<button onclick="changePage(${currentPage + 1})" ${!data.has_next ? 'disabled' : ''}>
            Next <i class="fas fa-chevron-right"></i>
        </button>`;

        pagination.innerHTML = html;
    }

    function changePage(page) {
        currentPage = page;
        loadCars();
    }

    async function toggleCarActive(carId) {
        if (!confirm('Are you sure you want to change the car status?')) return;

        try {
            const car = await apiCall(`/cars/${carId}/toggle-active`, {
                method: 'POST'
            });

            showAlert(`Car ${car.active ? 'activated' : 'deactivated'} successfully`, 'success');
            loadCars();
        } catch (error) {
            showAlert('Error updating car: ' + error.message, 'danger');
        }
    }

    async function deleteCar(carId) {
        if (!confirm('Are you sure you want to delete this car? This action cannot be undone.')) return;

        try {
            await apiCall(`/cars/${carId}`, {
                method: 'DELETE'
            });

            showAlert('Car deleted successfully', 'success');
            loadCars();
        } catch (error) {
            showAlert('Error deleting car: ' + error.message, 'danger');
        }
    }

    // Search on Enter key
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            loadCars();
        }
    });

    // Don't call loadCars() here - it will be called in extra_js block after apiCall is loaded
</script>
{% endblock %}

{% block extra_js %}
<script>
    // Load cars on page load
    loadCars();
</script>
{% endblock %}