{% extends "admin/base.html" %}

{% block title %}Locations Management - Admin Panel{% endblock %}

{% block page_title %}Locations Management{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-map-marker-alt" style="color: var(--primary); margin-right: 10px;"></i>All Locations</h3>
        <button class="btn btn-primary" onclick="showCreateModal()">
            <i class="fas fa-plus"></i> Add New Location
        </button>
    </div>
    <div id="loadingSpinner" class="spinner" style="display: none;"></div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Location Name</th>
                    <th>Maps Link</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="locationsTable">
                <tr>
                    <td colspan="4" style="text-align: center; color: var(--gray);">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="locationModal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div
        style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 id="modalTitle">Add Location</h3>
            <button onclick="closeModal()"
                style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray);">&times;</button>
        </div>
        <form id="locationForm">
            <input type="hidden" id="locationId" name="location_id">
            <div class="form-group">
                <label for="locationName">Location Name *</label>
                <input type="text" id="locationName" name="location" class="form-control" required
                    placeholder="e.g., Banjara Hills, Hyderabad">
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label for="mapsLink">Maps Link</label>
                <input type="url" id="mapsLink" name="maps_link" class="form-control"
                    placeholder="https://maps.google.com/... or https://goo.gl/maps/...">
                <small style="color: var(--gray); font-size: 12px; margin-top: 5px; display: block;">
                    Enter Google Maps link or any map service URL for this location
                </small>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save
                </button>
                <button type="button" onclick="closeModal()" class="btn btn-outline">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    #locationModal {
        display: none;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let editingLocationId = null;

    async function loadLocations() {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const locationsTable = document.getElementById('locationsTable');

        loadingSpinner.style.display = 'block';
        locationsTable.innerHTML = '<tr><td colspan="4" style="text-align: center;">Loading...</td></tr>';

        try {
            const data = await apiCall('/locations?page=1&page_size=100');

            if (data.items && data.items.length > 0) {
                locationsTable.innerHTML = data.items.map(location => {
                    const mapsLink = location.maps_link || '';
                    const mapsLinkDisplay = mapsLink ?
                        `<a href="${mapsLink}" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none; max-width: 200px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${mapsLink}">
                            <i class="fas fa-external-link-alt"></i> View Map
                        </a>` :
                        '<span style="color: var(--gray); font-style: italic;">Not set</span>';
                    // Escape for JavaScript string (handle quotes, backslashes, newlines)
                    const locationNameEscaped = location.location.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
                    const mapsLinkEscaped = (mapsLink || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
                    return `
                    <tr>
                        <td>#${location.id}</td>
                        <td><strong>${location.location}</strong></td>
                        <td>${mapsLinkDisplay}</td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="editLocation(${location.id}, '${locationNameEscaped}', '${mapsLinkEscaped}')" 
                                        class="btn btn-outline" style="padding: 5px 10px; font-size: 12px;">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button onclick="deleteLocation(${location.id})" 
                                        class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                }).join('');
            } else {
                locationsTable.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px;">
                            <i class="fas fa-map-marker-alt" style="font-size: 48px; color: var(--gray); margin-bottom: 15px; display: block;"></i>
                            <p style="color: var(--gray); font-size: 16px; margin: 0;">No locations yet</p>
                            <p style="color: var(--gray); font-size: 14px; margin-top: 5px;">Click "Add New Location" to create your first pickup/drop location</p>
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Error loading locations:', error);
            locationsTable.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--danger);">Error loading locations</td></tr>';
            showAlert('Error loading locations: ' + error.message, 'danger');
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }

    function showCreateModal() {
        editingLocationId = null;
        document.getElementById('modalTitle').textContent = 'Add Location';
        document.getElementById('locationForm').reset();
        document.getElementById('locationId').value = '';
        document.getElementById('mapsLink').value = '';
        document.getElementById('locationModal').style.display = 'flex';
    }

    function editLocation(id, name, mapsLink = '') {
        editingLocationId = id;
        document.getElementById('modalTitle').textContent = 'Edit Location';
        document.getElementById('locationId').value = id;
        document.getElementById('locationName').value = name;
        document.getElementById('mapsLink').value = mapsLink || '';
        document.getElementById('locationModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('locationModal').style.display = 'none';
        editingLocationId = null;
        document.getElementById('locationForm').reset();
    }

    async function deleteLocation(locationId) {
        if (!confirm('Are you sure you want to delete this location? This action cannot be undone. Make sure no cars are using this location.')) {
            return;
        }

        try {
            await apiCall(`/locations/${locationId}`, {
                method: 'DELETE'
            });

            showAlert('Location deleted successfully', 'success');
            loadLocations();
        } catch (error) {
            showAlert('Error deleting location: ' + error.message, 'danger');
        }
    }

    // Set up form submit handler
    document.getElementById('locationForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const locationName = document.getElementById('locationName').value.trim();
        if (!locationName) {
            showAlert('Location name is required', 'danger');
            return;
        }

        const mapsLink = document.getElementById('mapsLink').value.trim();

        try {
            const locationData = {
                location: locationName,
                maps_link: mapsLink || null
            };

            if (editingLocationId) {
                // Update existing location
                await apiCall(`/locations/${editingLocationId}`, {
                    method: 'PUT',
                    body: JSON.stringify(locationData),
                    headers: { 'Content-Type': 'application/json' }
                });
                showAlert('Location updated successfully!', 'success');
            } else {
                // Create new location
                await apiCall('/locations', {
                    method: 'POST',
                    body: JSON.stringify(locationData),
                    headers: { 'Content-Type': 'application/json' }
                });
                showAlert('Location created successfully!', 'success');
            }

            closeModal();
            loadLocations();
        } catch (error) {
            showAlert('Error saving location: ' + error.message, 'danger');
        }
    });

    // Close modal on background click
    document.getElementById('locationModal').addEventListener('click', (e) => {
        if (e.target.id === 'locationModal') {
            closeModal();
        }
    });

    // Load locations on page load
    loadLocations();
</script>
{% endblock %}