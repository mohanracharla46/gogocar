{% extends "admin/base.html" %}

{% block title %}Bookings Management - Admin Panel{% endblock %}

{% block page_title %}Bookings Management{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header" style="flex-wrap: wrap; gap: 20px;">
        <h3><i class="fas fa-calendar-alt" style="color: var(--primary); margin-right: 12px;"></i>Reservations Hub</h3>
        <div style="display: flex; gap: 12px;">
            <button onclick="resetFilters()" class="btn btn-outline" style="padding: 10px 15px;">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button onclick="loadBookings()" class="btn btn-primary">
                <i class="fas fa-search"></i> Find Bookings
            </button>
        </div>
    </div>

    <div
        style="margin-bottom: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: #f8fafc; padding: 25px; border-radius: 20px; border: 1px solid var(--border);">
        <div class="form-group" style="margin-bottom: 0;">
            <label style="font-size: 11px; text-transform: uppercase; color: var(--gray);">Booking Status</label>
            <select id="filterStatus" class="form-control" style="margin-top: 5px;">
                <option value="">All Statuses</option>
                <option value="PENDING">Pending Approval</option>
                <option value="APPROVED">Confirmed</option>
                <option value="ONGOING">In Transit</option>
                <option value="COMPLETED">Finished</option>
                <option value="CANCELLED">Voided</option>
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label style="font-size: 11px; text-transform: uppercase; color: var(--gray);">Customer Search</label>
            <input type="number" id="filterUserId" class="form-control" placeholder="Search by User ID..."
                style="margin-top: 5px;">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label style="font-size: 11px; text-transform: uppercase; color: var(--gray);">Vehicle Search</label>
            <input type="number" id="filterCarId" class="form-control" placeholder="Search by Car ID..."
                style="margin-top: 5px;">
        </div>
    </div>



    <div id="loadingSpinner" class="spinner" style="display: none; margin: 40px auto;"></div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Reservation Info</th>
                    <th>Rental Period</th>
                    <th>Payment</th>
                    <th>Current State</th>
                    <th style="text-align: right;">Operations</th>
                </tr>
            </thead>
            <tbody id="bookingsTable">
                <tr>
                    <td colspan="5" style="text-align: center; padding: 60px; color: var(--gray);">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px;">Retrieving latest reservations...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="pagination" id="pagination"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    const pageSize = 20;

    async function loadBookings() {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const bookingsTable = document.getElementById('bookingsTable');

        loadingSpinner.style.display = 'block';
        bookingsTable.innerHTML = '<tr><td colspan="8" style="text-align: center;">Loading...</td></tr>';

        try {
            const statusFilter = document.getElementById('filterStatus').value;
            const userIdFilter = document.getElementById('filterUserId').value;
            const carIdFilter = document.getElementById('filterCarId').value;

            let url = `/bookings?page=${currentPage}&page_size=${pageSize}`;
            if (statusFilter) url += `&status=${statusFilter}`;
            if (userIdFilter) url += `&user_id=${userIdFilter}`;
            if (carIdFilter) url += `&car_id=${carIdFilter}`;

            const data = await apiCall(url);

            if (data.items && data.items.length > 0) {
                bookingsTable.innerHTML = data.items.map(booking => {
                    let userName = `User #${booking.user_id}`;
                    if (booking.user_firstname || booking.user_lastname) {
                        const first = booking.user_firstname || '';
                        const last = booking.user_lastname || '';
                        userName = `${first} ${last}`.trim() || userName;
                    }

                    let carName = `Car #${booking.car_id}`;
                    if (booking.car_brand || booking.car_model) {
                        const brand = booking.car_brand || '';
                        const model = booking.car_model || '';
                        carName = `${brand} ${model}`.trim() || carName;
                    }

                    return `
                    <tr>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-weight: 800; color: var(--dark);">#${booking.id}</span>
                                    <span style="width: 4px; height: 4px; border-radius: 50%; background: var(--border);"></span>
                                    <a href="/admin/users/${booking.user_id}" style="color: var(--primary); text-decoration: none; font-weight: 600; font-size: 13px;">${userName}</a>
                                </div>
                                <div style="margin-top: 4px; font-size: 12px; color: var(--gray);">
                                    <i class="fas fa-car" style="font-size: 10px; margin-right: 5px;"></i> ${carName}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; font-size: 13px;">
                                <span style="font-weight: 600; color: #334155;">${formatDate(booking.start_time)}</span>
                                <span style="font-size: 11px; color: var(--gray);">to ${formatDate(booking.end_time)}</span>
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: 800; color: var(--primary); font-size: 15px;">${formatCurrency(booking.total_amount)}</div>
                            <div style="font-size: 10px; color: var(--gray); font-weight: 600;">INC. TAXES</div>
                        </td>
                        <td><span class="badge badge-${getStatusColor(booking.order_status)}">${booking.order_status}</span></td>
                        <td style="text-align: right;">
                            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                <a href="/admin/bookings/${booking.id}" class="btn btn-outline" style="padding: 8px; width: 36px; height: 36px; justify-content: center;" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                ${booking.order_status === 'PENDING' ? `
                                    <button onclick="updateStatus(${booking.id}, 'APPROVED')" class="btn btn-primary" 
                                            style="padding: 8px; width: 36px; height: 36px; justify-content: center;" title="Approve">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                                ${['PENDING', 'APPROVED', 'BOOKED'].includes(booking.order_status) ? `
                                    <button onclick="cancelBooking(${booking.id})" class="btn btn-outline" 
                                            style="padding: 8px; width: 36px; height: 36px; justify-content: center; color: var(--danger); border-color: rgba(239, 68, 68, 0.2);" title="Cancel Booking">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
                }).join('');

                updatePagination(data);
            } else {
                bookingsTable.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <i class="fas fa-calendar-times" style="font-size: 48px; color: var(--gray); margin-bottom: 15px; display: block;"></i>
                            <p style="color: var(--gray); font-size: 16px; margin: 0;">No bookings yet</p>
                            <p style="color: var(--gray); font-size: 14px; margin-top: 5px;">Bookings will appear here once customers start renting cars</p>
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Error loading bookings:', error);
            bookingsTable.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--danger);">Error loading bookings</td></tr>';
            showAlert('Error loading bookings: ' + error.message, 'danger');
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }


    function updatePagination(data) {
        const pagination = document.getElementById('pagination');
        const totalPages = data.total_pages || 1;

        let html = '';

        html += `<button onclick="changePage(${currentPage - 1})" ${!data.has_prev ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i> Previous
        </button>`;

        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `<button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += '<span>...</span>';
            }
        }

        html += `<button onclick="changePage(${currentPage + 1})" ${!data.has_next ? 'disabled' : ''}>
            Next <i class="fas fa-chevron-right"></i>
        </button>`;

        pagination.innerHTML = html;
    }

    function changePage(page) {
        currentPage = page;
        loadBookings();
    }

    async function updateStatus(bookingId, status) {
        if (!confirm(`Are you sure you want to ${status.toLowerCase()} this booking?`)) return;

        try {
            await apiCall(`/bookings/${bookingId}`, {
                method: 'PUT',
                body: JSON.stringify({ order_status: status }),
                headers: { 'Content-Type': 'application/json' }
            });

            showAlert(`Booking ${status.toLowerCase()} successfully`, 'success');
            loadBookings();
        } catch (error) {
            showAlert('Error updating booking: ' + error.message, 'danger');
        }
    }

    async function cancelBooking(bookingId) {
        const reason = prompt('Please provide cancellation reason:');
        if (!reason) return;

        if (!confirm('Are you sure you want to cancel this booking? Refund will be processed according to policy.')) return;

        try {
            await apiCall(`/bookings/${bookingId}/cancel`, {
                method: 'POST',
                body: JSON.stringify({ cancellation_reason: reason }),
                headers: { 'Content-Type': 'application/json' }
            });

            showAlert('Booking cancelled successfully. Refund initiated if applicable.', 'success');
            loadBookings();
        } catch (error) {
            showAlert('Error cancelling booking: ' + error.message, 'danger');
        }
    }

    function resetFilters() {
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterUserId').value = '';
        document.getElementById('filterCarId').value = '';
        currentPage = 1;
        loadBookings();
    }

    // Initialize
    loadBookings();
</script>
{% endblock %}