{% extends "admin/base.html" %}

{% block title %}Bookings Management - Admin Panel{% endblock %}

{% block page_title %}Bookings Management{% endblock %}

{% block content %}

<!-- Quick Action Cards (Revv-style) -->
<style>
    .quick-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 30px;
    }

    .quick-action-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 18px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        color: inherit;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        border: 1px solid #f1f5f9;
    }

    .quick-action-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border-color: #e2e8f0;
    }

    .quick-action-card.active-filter {
        border-color: var(--primary);
        box-shadow: 0 4px 15px rgba(43, 57, 144, 0.15);
    }

    .quick-action-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .quick-action-icon {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
    }

    .quick-action-icon.new {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .quick-action-icon.delivery {
        background: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
    }

    .quick-action-icon.pickup {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }

    .quick-action-icon.ongoing {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .quick-action-icon.all {
        background: rgba(100, 116, 139, 0.1);
        color: #64748b;
    }

    .quick-action-label {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
    }

    .quick-action-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .quick-action-badge {
        background: #ef4444;
        color: #ffffff;
        font-size: 13px;
        font-weight: 700;
        padding: 3px 10px;
        border-radius: 20px;
        min-width: 28px;
        text-align: center;
        line-height: 1.4;
    }

    .quick-action-arrow {
        color: #cbd5e1;
        font-size: 16px;
        transition: transform 0.2s ease;
    }

    .quick-action-card:hover .quick-action-arrow {
        transform: translateX(3px);
        color: #94a3b8;
    }

    .quick-actions-title {
        font-size: 18px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .quick-actions-title i {
        color: var(--primary);
    }
</style>

<div class="quick-actions-title">
    <i class="fas fa-bolt"></i> Quick Actions
</div>
<div class="quick-actions">
    <a href="javascript:void(0)" class="quick-action-card" onclick="quickFilter('PENDING', 'New Bookings', event)">
        <div class="quick-action-left">
            <div class="quick-action-icon new"><i class="fas fa-plus-circle"></i></div>
            <span class="quick-action-label">New Bookings</span>
        </div>
        <div class="quick-action-right">
            {% if new_bookings|default(0) > 0 %}
            <span class="quick-action-badge">{{ new_bookings }}</span>
            {% endif %}
            <i class="fas fa-chevron-right quick-action-arrow"></i>
        </div>
    </a>
    <a href="javascript:void(0)" class="quick-action-card"
        onclick="quickFilter('BOOKED', 'Today\'s Deliveries', event)">
        <div class="quick-action-left">
            <div class="quick-action-icon delivery"><i class="fas fa-truck"></i></div>
            <span class="quick-action-label">Today's Deliveries</span>
        </div>
        <div class="quick-action-right">
            {% if todays_deliveries|default(0) > 0 %}
            <span class="quick-action-badge">{{ todays_deliveries }}</span>
            {% endif %}
            <i class="fas fa-chevron-right quick-action-arrow"></i>
        </div>
    </a>
    <a href="javascript:void(0)" class="quick-action-card" onclick="quickFilter('ONGOING', 'Today\'s Pickups', event)">
        <div class="quick-action-left">
            <div class="quick-action-icon pickup"><i class="fas fa-calendar-check"></i></div>
            <span class="quick-action-label">Today's Pickups</span>
        </div>
        <div class="quick-action-right">
            {% if todays_pickups|default(0) > 0 %}
            <span class="quick-action-badge">{{ todays_pickups }}</span>
            {% endif %}
            <i class="fas fa-chevron-right quick-action-arrow"></i>
        </div>
    </a>
    <a href="javascript:void(0)" class="quick-action-card" onclick="quickFilter('ONGOING', 'Ongoing Bookings', event)">
        <div class="quick-action-left">
            <div class="quick-action-icon ongoing"><i class="fas fa-car-side"></i></div>
            <span class="quick-action-label">Ongoing Bookings</span>
        </div>
        <div class="quick-action-right">
            {% if ongoing_bookings|default(0) > 0 %}
            <span class="quick-action-badge">{{ ongoing_bookings }}</span>
            {% endif %}
            <i class="fas fa-chevron-right quick-action-arrow"></i>
        </div>
    </a>
    <a href="javascript:void(0)" class="quick-action-card" onclick="quickFilter('', 'All Bookings', event)">
        <div class="quick-action-left">
            <div class="quick-action-icon all"><i class="fas fa-th-list"></i></div>
            <span class="quick-action-label">All Bookings</span>
        </div>
        <div class="quick-action-right">
            <i class="fas fa-chevron-right quick-action-arrow"></i>
        </div>
    </a>
</div>

<div class="card">
    <div class="card-header" style="flex-wrap: wrap; gap: 20px;">
        <h3 id="reservationsHeading"><i class="fas fa-calendar-alt"
                style="color: var(--primary); margin-right: 12px;"></i>Reservations Hub</h3>
        <div style="display: flex; gap: 12px;">
            <button onclick="resetFilters()" class="btn btn-outline" style="padding: 10px 15px;">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button onclick="loadBookings()" class="btn btn-primary">
                <i class="fas fa-search"></i> Find Bookings
            </button>
        </div>
    </div>

    <div
        style="margin-bottom: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: #f8fafc; padding: 25px; border-radius: 20px; border: 1px solid var(--border);">
        <div class="form-group" style="margin-bottom: 0;">
            <label style="font-size: 11px; text-transform: uppercase; color: var(--gray);">Booking Status</label>
            <select id="filterStatus" class="form-control" style="margin-top: 5px;">
                <option value="">All Statuses</option>
                <option value="PENDING">Pending Approval</option>
                <option value="APPROVED">Confirmed</option>
                <option value="BOOKED">Booked (Ready for Delivery)</option>
                <option value="ONGOING">In Transit</option>
                <option value="COMPLETED">Finished</option>
                <option value="CANCELLED">Voided</option>
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label style="font-size: 11px; text-transform: uppercase; color: var(--gray);">Customer Search</label>
            <input type="number" id="filterUserId" class="form-control" placeholder="Search by User ID..."
                style="margin-top: 5px;">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label style="font-size: 11px; text-transform: uppercase; color: var(--gray);">Vehicle Search</label>
            <input type="number" id="filterCarId" class="form-control" placeholder="Search by Car ID..."
                style="margin-top: 5px;">
        </div>
    </div>



    <div id="loadingSpinner" class="spinner" style="display: none; margin: 40px auto;"></div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Reservation Info</th>
                    <th>Rental Period</th>
                    <th>Payment</th>
                    <th>Current State</th>
                    <th style="text-align: right;">Operations</th>
                </tr>
            </thead>
            <tbody id="bookingsTable">
                <tr>
                    <td colspan="5" style="text-align: center; padding: 60px; color: var(--gray);">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px;">Retrieving latest reservations...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="pagination" id="pagination"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    const pageSize = 20;

    async function loadBookings() {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const bookingsTable = document.getElementById('bookingsTable');

        loadingSpinner.style.display = 'block';
        bookingsTable.innerHTML = '<tr><td colspan="8" style="text-align: center;">Loading...</td></tr>';

        try {
            const statusFilter = document.getElementById('filterStatus').value;
            const userIdFilter = document.getElementById('filterUserId').value;
            const carIdFilter = document.getElementById('filterCarId').value;

            let url = `/bookings?page=${currentPage}&page_size=${pageSize}`;
            if (statusFilter) url += `&status=${statusFilter}`;
            if (userIdFilter) url += `&user_id=${userIdFilter}`;
            if (carIdFilter) url += `&car_id=${carIdFilter}`;

            const data = await apiCall(url);

            if (data.items && data.items.length > 0) {
                bookingsTable.innerHTML = data.items.map(booking => {
                    let userName = `User #${booking.user_id}`;
                    if (booking.user_firstname || booking.user_lastname) {
                        const first = booking.user_firstname || '';
                        const last = booking.user_lastname || '';
                        userName = `${first} ${last}`.trim() || userName;
                    }

                    let carName = `Car #${booking.car_id}`;
                    if (booking.car_brand || booking.car_model) {
                        const brand = booking.car_brand || '';
                        const model = booking.car_model || '';
                        carName = `${brand} ${model}`.trim() || carName;
                    }

                    return `
                    <tr>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-weight: 800; color: var(--dark);">#${booking.id}</span>
                                    <span style="width: 4px; height: 4px; border-radius: 50%; background: var(--border);"></span>
                                    <a href="/admin/users/${booking.user_id}" style="color: var(--primary); text-decoration: none; font-weight: 600; font-size: 13px;">${userName}</a>
                                </div>
                                <div style="margin-top: 4px; font-size: 12px; color: var(--gray);">
                                    <i class="fas fa-car" style="font-size: 10px; margin-right: 5px;"></i> ${carName}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; font-size: 13px;">
                                <span style="font-weight: 600; color: #334155;">${formatDate(booking.start_time)}</span>
                                <span style="font-size: 11px; color: var(--gray);">to ${formatDate(booking.end_time)}</span>
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: 800; color: var(--primary); font-size: 15px;">${formatCurrency(booking.total_amount)}</div>
                            <div style="font-size: 10px; color: var(--gray); font-weight: 600;">INC. TAXES</div>
                        </td>
                        <td><span class="badge badge-${getStatusColor(booking.order_status)}">${booking.order_status}</span></td>
                        <td style="text-align: right;">
                            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                <a href="/admin/bookings/${booking.id}" class="btn btn-outline" style="padding: 8px; width: 36px; height: 36px; justify-content: center;" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                ${booking.order_status === 'PENDING' ? `
                                    <button onclick="updateStatus(${booking.id}, 'APPROVED')" class="btn btn-primary" 
                                            style="padding: 8px; width: 36px; height: 36px; justify-content: center;" title="Approve">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                                ${['PENDING', 'APPROVED', 'BOOKED'].includes(booking.order_status) ? `
                                    <button onclick="cancelBooking(${booking.id})" class="btn btn-outline" 
                                            style="padding: 8px; width: 36px; height: 36px; justify-content: center; color: var(--danger); border-color: rgba(239, 68, 68, 0.2);" title="Cancel Booking">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
                }).join('');

                updatePagination(data);
            } else {
                bookingsTable.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <i class="fas fa-calendar-times" style="font-size: 48px; color: var(--gray); margin-bottom: 15px; display: block;"></i>
                            <p style="color: var(--gray); font-size: 16px; margin: 0;">No bookings yet</p>
                            <p style="color: var(--gray); font-size: 14px; margin-top: 5px;">Bookings will appear here once customers start renting cars</p>
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Error loading bookings:', error);
            bookingsTable.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--danger);">Error loading bookings</td></tr>';
            showAlert('Error loading bookings: ' + error.message, 'danger');
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }


    function updatePagination(data) {
        const pagination = document.getElementById('pagination');
        const totalPages = data.total_pages || 1;

        let html = '';

        html += `<button onclick="changePage(${currentPage - 1})" ${!data.has_prev ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i> Previous
        </button>`;

        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `<button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += '<span>...</span>';
            }
        }

        html += `<button onclick="changePage(${currentPage + 1})" ${!data.has_next ? 'disabled' : ''}>
            Next <i class="fas fa-chevron-right"></i>
        </button>`;

        pagination.innerHTML = html;
    }

    function changePage(page) {
        currentPage = page;
        loadBookings();
    }

    async function updateStatus(bookingId, status) {
        if (!confirm(`Are you sure you want to ${status.toLowerCase()} this booking?`)) return;

        try {
            await apiCall(`/bookings/${bookingId}`, {
                method: 'PUT',
                body: JSON.stringify({ order_status: status }),
                headers: { 'Content-Type': 'application/json' }
            });

            showAlert(`Booking ${status.toLowerCase()} successfully`, 'success');
            loadBookings();
        } catch (error) {
            showAlert('Error updating booking: ' + error.message, 'danger');
        }
    }

    async function cancelBooking(bookingId) {
        const reason = prompt('Please provide cancellation reason:');
        if (!reason) return;

        if (!confirm('Are you sure you want to cancel this booking? Refund will be processed according to policy.')) return;

        try {
            await apiCall(`/bookings/${bookingId}/cancel`, {
                method: 'POST',
                body: JSON.stringify({ cancellation_reason: reason }),
                headers: { 'Content-Type': 'application/json' }
            });

            showAlert('Booking cancelled successfully. Refund initiated if applicable.', 'success');
            loadBookings();
        } catch (error) {
            showAlert('Error cancelling booking: ' + error.message, 'danger');
        }
    }

    function resetFilters() {
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterUserId').value = '';
        document.getElementById('filterCarId').value = '';
        currentPage = 1;
        loadBookings();
    }

    // Quick filter from action cards
    function quickFilter(status, label, e) {
        document.getElementById('filterStatus').value = status;
        document.getElementById('filterUserId').value = '';
        document.getElementById('filterCarId').value = '';
        currentPage = 1;
        loadBookings();

        // Highlight active card
        document.querySelectorAll('.quick-action-card').forEach(c => c.classList.remove('active-filter'));
        if (e && e.currentTarget) e.currentTarget.classList.add('active-filter');

        // Update heading
        const heading = document.getElementById('reservationsHeading');
        if (heading) {
            heading.innerHTML = '<i class="fas fa-calendar-alt" style="color: var(--primary); margin-right: 12px;"></i>' + (label || 'Reservations Hub');
        }

        // Scroll to table
        document.querySelector('.card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Check URL params for initial filter
    const urlParams = new URLSearchParams(window.location.search);
    const statusParam = urlParams.get('status');
    if (statusParam) {
        document.getElementById('filterStatus').value = statusParam;
    }

    // Initialize
    loadBookings();
</script>
{% endblock %}